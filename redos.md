# ReDoS



## 資料
[ReDoSから学ぶ，正規表現の脆弱性について - Qiita](https://qiita.com/flat-field/items/f5b0c803ba0b7030d97a)
[正規表現の落とし穴（ReDoS - Regular Expressions DoS） - Qiita](https://qiita.com/prograti/items/9b54cf82a08302a5d2c7)


## 説明
ReDoS攻撃 とは，正規表現エンジンに対して処理時間が多くかかる入力を与えることで，サービス停止が起こってしまう脆弱性をついた攻撃手法である．


## 事例
- [Stack Exchange Network Status — Outage Postmortem - July 20, 2016](https://stackstatus.net/post/147710624694/outage-postmortem-july-20-2016)
  - 2016年，Stack Overflowのサーバが，連続した空白を2万個含む投稿が原因でダウン 
- [【俺の屍を】クソ正規表現で本番サイトを吹っ飛ばした話【超えていけ】 - Qiita](https://qiita.com/paddy-oti/items/399a0bbd16f3f062c666)
  - 口コミのテキストを整形する処理で，脆弱性のある正規表現を使っていたために本番サイトがダウン


## 原因
VM型エンジンのバックトラックが指数関数的に増加してしまうこと．


ReDoSが起こるケース（現時点での見解）
- `/(a*)*b/`のように量指定子がネストされている．
- `/(.|\w)*/`のように両方にサブマッチする選択が繰り返されている．


## 対策

- 独自の正規表現は使わない
  - 他の文字列処理方法を考える．
- ライブラリを最新にする
  - 標準ライブラリでさえもReDoS脆弱性がある場合がある．
- タイムアウトを設定する
  - 処理時間が長過ぎる場合にエラーを起こすようにする．
- DFA型を使う
  - バックトラックの指数関数的増加はVM型の特徴なので，非バックトラッキングエンジンを用いて防ぐ．
  - [追加の非バックトラッキング正規表現エンジン・V8](https://v8.dev/blog/non-backtracking-regexp)
  - Node.jsバージョン16ではV8エンジンが8.6→9.0になり，オプションをつけると非バックトラッキングエンジンでの実行が可能になった

やむおえず独自の正規表現を使わざるを得ない場合は，次の点に注意する．
-  入力文字数を制限して長い文字列で処理させない
-  `*`や`+`など，繰り返し表現はなるべく使わない
-  せめて，`*?`や`+?`などの控え目な量指定子を使う（欲張り量指定子は使わない）
-  `{n}`などの範囲量指定子を使って繰り返し回数の上限を決める．
-  `^`を付ける

