# 正規表現エンジン

目次

<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [正規表現エンジン](#正規表現エンジン)
  - [基本情報](#基本情報)
    - [正規表現エンジンの種類](#正規表現エンジンの種類)
  - [DFA型エンジン](#dfa型エンジン)
  - [VM型エンジン](#vm型エンジン)
    - [バックトラック](#バックトラック)

<!-- /code_chunk_output -->



## 基本情報
様々な正規表現エンジンが考案されてきたが，その実装は大きく2種類に分けられる．
- DFA型：正規表現を決定性有限オートマトンに変換して正規表現マッチングをする
- VM型：正規表現をバイトコードに変換して正規表現マッチングをする

### 正規表現エンジンの種類
[Comparison of wiki software - Wikipedia](https://nipponkaigi.net/wiki/Comparison_of_regular-expression_engines)では，正規表現エンジンの比較表が掲載されている．

それぞれの正規表現エンジンによって得手不得手なパターンもあるため，一概にどれが優秀とは言えないが，おおまかにはDFA型はパフォーマンス重視，VM型は機能重視といった傾向がある．
対応する機能数や消費メモリ量，実行速度などを比較して特徴づけられる．

正規表現エンジンの一例
- DFA型
  - GNU grep
  - Google RE2
- VM型
  - PCRE (pcregrep)
  - 鬼車
  - 多くのスクリプト言語の正規表現ライブラリ



## DFA型エンジン
DFA型エンジンは，以下の手順でマッチングを行う．
1. 正規表現をNFAに変換 
2. NFAをDFAに変換 
3. DFAをシミュレーション

## VM型エンジン
VM型エンジンは，以下の手順でマッチングを行う．
1. 正規表現をバイトコードに変換
   1. パーサが解析して抽象構文木を生成
   2. コンパイラが抽象構文木を最適化した上でバイトコードへ変換
2. VM本体でバイトコードを解釈してマッチング

### バックトラック
バックトラックとは，次のような手順で問題の解を見つけるアルゴリズム．
可能性のある候補を順に試し，ある候補が解でないと判明したときには解の可能性のあるところまで戻って次の候補を試す．

VM本体でバイトコードと入力文字列のマッチングを行う際は，以下の表のように，バックトラックを行いながら実行される．
VM型エンジンでのバックトラックの挙動については，[regex101](https://regex101.com/)のTOOLSメニューにあるRegex Debuggerという機能を用いたシミュレーションが理解の助けになる．


|              パターン              |       文字列        |                            動作                            |
| ---------------------------------- | ------------------- | ---------------------------------------------------------- |
| **a**(b&#124;c)<br>^               | **a**c<br>^         | パターンの**a**と文字列の**a**がマッチ                     |
| a(**b**&#124;c)<br>&emsp;^         | a**c**<br>&emsp;^   | パターンの**b**と文字列の**c**がマッチ失敗                 |
| **a**(b&#124;c)<br>^               | **a**c<br>^         | 直前の選択肢まで戻る                                       |
| a(b&#124;**c**)<br>&emsp;&emsp;^   | a**c**<br>&emsp;^   | 直前の選択肢である，パターンの**c**と文字列の**c**がマッチ |
| a(b&#124;c)<br>&emsp;&emsp;&emsp;^ | ac<br>&emsp;&emsp;^ | パターンの終端に到達し，マッチ成功                         |


